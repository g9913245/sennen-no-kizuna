<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>千年の絆</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;
  touch-action:manipulation;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
canvas{display:block;margin:0 auto;background:#000}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;z-index:10;gap:6px}
.btn{pointer-events:auto;border:none;border-radius:10px;padding:15px 40px;
  font-size:17px;font-weight:bold;cursor:pointer;font-family:serif;letter-spacing:2px;
  transition:transform 0.08s;display:none;position:relative;overflow:hidden}
.btn:active{transform:scale(0.93)}
.btn-gold{background:linear-gradient(135deg,#b8942e,#f5d98a,#c8a84e);color:#1a0a2e;
  box-shadow:0 0 20px rgba(245,217,138,0.3)}
.btn-fire{background:linear-gradient(135deg,#cc3300,#ff6633,#ffaa44);color:#fff;
  box-shadow:0 0 20px rgba(255,100,50,0.4)}
.btn-subtle{background:rgba(100,100,140,0.4);color:#aab;border:1px solid rgba(150,150,200,0.3);
  padding:12px 30px;font-size:14px}
#btn-start{display:inline-block}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <button id="btn-start" class="btn btn-gold">&#x2015; 応援を始める &#x2015;</button>
  <button id="btn-next" class="btn btn-fire">次のレベルへ &#x2192;</button>
  <button id="btn-retry" class="btn btn-gold">もう一度挑む</button>
  <button id="btn-title" class="btn btn-subtle">タイトルへ</button>
</div>
<script>
(function(){
var C = document.getElementById("c");
var X = C.getContext("2d");
var VW = 400, VH = 720, SC = 1, OY = 0;

function resize(){
  var w = window.innerWidth, h = window.innerHeight;
  SC = Math.min(w / VW, h / VH);
  C.width = VW * SC; C.height = VH * SC;
  C.style.width = C.width + "px";
  C.style.height = C.height + "px";
  OY = (h - C.height) / 2;
  C.style.marginTop = OY + "px";
}
window.addEventListener("resize", resize); resize();

var AC = null;
function initA(){ if(!AC) AC = new (window.AudioContext || window.webkitAudioContext)(); }
function beep(f, d, v, t){
  if(!AC) return;
  try{
    var o = AC.createOscillator(), g = AC.createGain();
    o.type = t || "sine"; o.frequency.value = f || 880;
    g.gain.setValueAtTime(v || 0.12, AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + (d || 0.06));
    o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + (d || 0.06));
  } catch(e){}
}
function sndPerfect(){ beep(1320,0.07,0.18); beep(1980,0.05,0.08,"triangle"); }
function sndGood(){ beep(880,0.05,0.12,"triangle"); }
function sndMiss(){ beep(150,0.18,0.08,"sawtooth"); beep(120,0.12,0.05,"square"); }
function sndGold(){ beep(1760,0.1,0.15); setTimeout(function(){ beep(2200,0.08,0.1,"triangle"); },50); }
function sndDanger(){ beep(100,0.25,0.12,"square"); beep(80,0.2,0.08,"sawtooth"); }
function sndPhase(){
  var fs=[523,659,784]; for(var i=0;i<fs.length;i++)(function(ii){setTimeout(function(){beep(fs[ii],0.3,0.1);},ii*70);})(i);
}
function sndFever(){
  var fs=[880,1100,1320,1760]; for(var i=0;i<fs.length;i++)(function(ii){setTimeout(function(){beep(fs[ii],0.15,0.1,"triangle");},ii*50);})(i);
}
function sndClear(){
  var fs=[523,659,784,1047,1319]; for(var i=0;i<fs.length;i++)(function(ii){setTimeout(function(){beep(fs[ii],0.4,0.12);},ii*100);})(i);
}
function sndLvUp(){
  var fs=[660,880,1100,1320,1760,2200]; for(var i=0;i<fs.length;i++)(function(ii){setTimeout(function(){beep(fs[ii],0.2,0.1,"triangle");},ii*60);})(i);
}

var ST = {TITLE:"t", PLAY:"p", CLEAR:"c", FAIL:"f"};
var state = ST.TITLE;
var lv = 1, bestLv = 1, MAX_LV = 99;
var LV_NAMES = ["","\u898B\u7FD2\u3044\u5FDC\u63F4\u58EB","\u5FDC\u63F4\u306E\u5FC3\u5F97","\u58F0\u306E\u5C4A\u304F\u8005","\u6642\u7A7A\u306E\u4F7F\u8005","\u6708\u5149\u306E\u5C0E\u304D\u624B","\u5343\u5E74\u306E\u67B6\u3051\u6A4B","\u4F1D\u8AAC\u306E\u63A8\u3057\u5E2B","\u7D46\u306E\u4F53\u73FE\u8005","\u4E0D\u6EC5\u306E\u5FDC\u63F4\u9B42","\u5343\u5E74\u306E\u7D46\u30FB\u6975"];
function lvName(l){ return l < LV_NAMES.length ? LV_NAMES[l] : "\u8D85\u8D8A\u8005\u3010"+l+"\u6BB5\u3011"; }

function lvP(l){
  var t = Math.min(l-1, 30);
  return {
    dur: Math.max(48, 75 - t*0.9),
    spd: 230 + t*10,
    spB: Math.max(0.20, 0.52 - t*0.012),
    spM: Math.max(0.13, 0.30 - t*0.006),
    pR: Math.max(10, 22 - t*0.4),
    gR: Math.max(24, 44 - t*0.7),
    yP: Math.max(1.6, 3.4 - t*0.06),
    yG: Math.max(0.7, 1.7 - t*0.035),
    cB: 0.5 + t*0.1,
    d2: t >= 2 ? Math.min(0.32, (t-2)*0.022) : 0,
    d3: t >= 5 ? Math.min(0.10, (t-5)*0.010) : 0,
    sr: 0.4 + t*0.025,
    gold: Math.min(0.12, 0.03 + t*0.004),
    danger: t >= 3 ? Math.min(0.10, (t-3)*0.008) : 0,
    feverTh: Math.max(10, 15 - Math.floor(t/4))
  };
}
var LP = lvP(1);

var LC=3, LW=88, LG=16, HZY=590, HZH=40, NR=18, YM=100, CBT=5;
var CN = ["\u77F3\u9020\u7687\u5B50","\u516C\u9054\uFF11","\u516C\u9054\uFF12"];
var CC = ["#f5d98a","#7ec8ff","#ff7eb3"];
var CC2 = ["#c8a84e","#4a9ad9","#d94a7a"];

var PH = [
  {th:0,lb:"\u5012\u308C\u3066\u3044\u308B\u2026",st:"fallen"},
  {th:20,lb:"\u818D\u3092\u3064\u304F\u2026",st:"kneel"},
  {th:40,lb:"\u7ACB\u3061\u4E0A\u304C\u308D\u3046\u3068\u2026",st:"rise"},
  {th:60,lb:"\u5200\u3092\u63E1\u308B\u2026\uFF01",st:"grip"},
  {th:80,lb:"\u7ACB\u3061\u4E0A\u304C\u3063\u305F\uFF01",st:"stand"},
  {th:100,lb:"\u8D70\u308A\u51FA\u3059\u2500\u2500\uFF01",st:"run"}
];

var SERIFU = {
  combo: [
    ["\u300C\u805E\u3053\u3048\u308B\u304B\u3001\u3053\u306E\u99AC\u9E7F\u91CE\u90CE\u300D","\u300C\u5343\u5E74\u306A\u3069\u4E00\u77AC\u3060\u2026\u304A\u524D\u306E\u305D\u3070\u306B\u5C45\u308B\u300D","\u300C\u6708\u306B\u8A93\u3063\u305F\u3002\u4FFA\u306F\u304A\u524D\u3092\u898B\u6368\u3066\u306A\u3044\u300D","\u300C\u7ACB\u3066\u3002\u304A\u524D\u306F\u305D\u3093\u306A\u3082\u306E\u3058\u3083\u306A\u3044\u300D"],
    ["\u300C\u5343\u5E74\u5148\u304B\u3089\u63A8\u3057\u3066\u308B\u300D","\u300C\u6642\u7A7A\uFF1F\u95A2\u4FC2\u306A\u3044\u306D\u3002\u63A8\u3057\u306F\u63A8\u3057\u300D","\u300C\u4FFA\u306E\u5FDC\u63F4\u304C\u3044\u3061\u3070\u3093\u5C4A\u3044\u3066\u308B\u306F\u305A\u300D","\u300C\u884C\u3051\u3088\u91D1\u592A\u90CE\uFF01\u5168\u4EBA\u985E\u304C\u6CE3\u304F\u305E\uFF01\u300D"],
    ["\u300C\u7ACB\u3066\u3088\u3001\u91D1\u592A\u90CE\u300D","\u300C\u6CE3\u3044\u3066\u306A\u3044\u3057\u2026\u5FDC\u63F4\u3057\u3066\u308B\u3060\u3051\u3060\u3057\u2026\u300D","\u300C\u3053\u3053\u3067\u8AF8\u3081\u305F\u3089\u2026\u63A8\u3057\u7532\u6590\u304C\u306A\u3044\u3060\u308D\u300D","\u300C\u304A\u524D\u306E\u80CC\u4E2D\u3001\u305A\u3063\u3068\u898B\u3066\u305F\u3093\u3060\u304B\u3089\u306A\u300D"]
  ],
  phase: ["\u91D1\u592A\u90CE\u306F\u6226\u5834\u306B\u5012\u308C\u3066\u3044\u308B\u2026","\u300C\u3046\u2026\u3050\u2026\u300D\u6307\u5148\u304C\u9707\u3048\u305F","\u300C\u8AB0\u304B\u306E\u2026\u58F0\u304C\u2026\u805E\u3053\u3048\u308B\u2026\u300D","\u300C\u3053\u306E\u5200\u306F\u2026\u307E\u3060\u3001\u63E1\u308C\u308B\u2026\uFF01\u300D","\u300C\u884C\u304B\u306A\u3051\u308C\u3070\u2026\u307F\u3093\u306A\u306E\u3082\u3068\u3078\u2026\uFF01\u300D","\u300C\u2500\u2500\u2500\u884C\u304F\u305E\uFF01\uFF01\u300D"],
  fever: ["\u300C\u300C\u300C\u5168\u529B\u5FDC\u63F4\u2500\u2500\uFF01\uFF01\u300D\u300D\u300D","\u300C\u300C\u300C\u63A8\u3057\u306E\u529B\u3092\u898B\u305B\u3066\u3084\u308B\uFF01\u300D\u300D\u300D","\u300C\u300C\u300C\u5343\u5E74\u306E\u7D46\u3001\u306A\u3081\u308B\u306A\u3088\uFF01\u300D\u300D\u300D"],
  high: ["\u300C\u4F55\u5EA6\u3067\u3082\u7ACB\u3061\u4E0A\u304C\u308C\u2026\uFF01\u300D","\u300C\u9650\u754C\uFF1F\u77E5\u3089\u3093\u306A\u300D","\u300C\u5168\u54E1\u306E\u9B42\u3092\u4E57\u305B\u308D\uFF01\u300D","\u300C\u4E0D\u53EF\u80FD\u3092\u53EF\u80FD\u306B\u3059\u308B\u306E\u304C\u63A8\u3057\u306E\u529B\u3060\u300D"]
};

var yell=0, combo=0, maxC=0, phase=0, tLeft=75, score=0;
var notes=[], ptcl=[], ftxt=[], trails=[];
var sDisp=null, shake=0, gThread=0, spTmr=0, lastT=0;
var tPerf=0, tGood=0, tMiss=0;
var phCh=false, phTmr=0, clrTmr=0, sIdx=0;
var fever=false, feverTmr=0, feverFlash=0;
var borderGlow=0, bgScroll=0;

var bS=document.getElementById("btn-start");
var bN=document.getElementById("btn-next");
var bR=document.getElementById("btn-retry");
var bT=document.getElementById("btn-title");
function hideB(){bS.style.display=bN.style.display=bR.style.display=bT.style.display="none";}

function reset(){
  LP=lvP(lv); yell=0; combo=0; maxC=0; phase=0; tLeft=LP.dur; score=0;
  notes=[]; ptcl=[]; ftxt=[]; trails=[];
  sDisp=null; shake=0; gThread=1; spTmr=0;
  tPerf=0; tGood=0; tMiss=0;
  phCh=false; phTmr=0; clrTmr=0; sIdx=0;
  fever=false; feverTmr=0; feverFlash=0;
  borderGlow=0; bgScroll=0; lastT=performance.now();
}

function startGame(){
  initA(); reset(); state=ST.PLAY; hideB();
  if(lv>=5) showS("Lv"+lv+"\uFF1A"+lvName(lv)+"\u2500\u2500\u8A66\u7DF4\u306F\u7D9A\u304F",2.5);
  else showS(SERIFU.phase[0],3);
}
function nextLv(){ lv=Math.min(MAX_LV,lv+1); if(lv>bestLv) bestLv=lv; sndLvUp(); startGame(); }

function spawnN(){
  var el=LP.dur-tLeft, sm=1+el/LP.dur*LP.sr;
  var lanes=[], r=Math.random();
  if(r<LP.d3) lanes=[0,1,2];
  else if(r<LP.d3+LP.d2){var a=[0,1,2]; a.splice(Math.floor(Math.random()*3),1); lanes=a;}
  else lanes=[Math.floor(Math.random()*LC)];
  for(var li=0;li<lanes.length;li++){
    var type="normal", r2=Math.random();
    if(r2<LP.gold) type="gold";
    else if(r2<LP.gold+LP.danger) type="danger";
    notes.push({lane:lanes[li],y:-NR,spd:LP.spd*sm,hit:false,miss:false,type:type,pulse:Math.random()*Math.PI*2});
  }
}

function laneX(i){
  var tw=LC*LW+(LC-1)*LG;
  return (VW-tw)/2+i*(LW+LG)+LW/2;
}

function tap(cx,cy){
  if(state!==ST.PLAY) return;
  var rect=C.getBoundingClientRect();
  var x=(cx-rect.left)/SC;
  var tl=0, md=Infinity;
  for(var i=0;i<LC;i++){var d=Math.abs(x-laneX(i)); if(d<md){md=d;tl=i;}}
  var best=null, bd=Infinity;
  for(var ni=0;ni<notes.length;ni++){
    var n=notes[ni];
    if(n.hit||n.miss||n.lane!==tl) continue;
    var d2=Math.abs(n.y-HZY);
    if(d2<LP.gR&&d2<bd){bd=d2; best=n;}
  }
  var lx=laneX(tl);
  if(best){
    if(best.type==="danger"){
      best.hit=true; combo=0; fever=false; yell=Math.max(0,yell-5); shake=6;
      addFT("DANGER!",lx,HZY-35,"#ff2222",1.2); spawnP(lx,HZY,"#ff2222",15); sndDanger(); return;
    }
    best.hit=true;
    var dist=Math.abs(best.y-HZY), isGold=best.type==="gold";
    var fMult=fever?1.5:1, gMult=isGold?2:1;
    if(dist<=LP.pR){
      var cb=combo>=CBT?LP.cB:0;
      yell=Math.min(YM,yell+(LP.yP+cb)*fMult*gMult);
      score+=Math.floor((100+combo*5)*gMult*(fever?2:1));
      combo++; tPerf++;
      addFT(isGold?"\u2605PERFECT\u2605":"PERFECT!",lx,HZY-35,isGold?"#ffee00":"#ffd700",isGold?1.3:1);
      spawnP(lx,HZY,isGold?"#ffee00":"#ffd700",isGold?20:12);
      if(isGold) sndGold(); else sndPerfect();
    }else{
      yell=Math.min(YM,yell+LP.yG*fMult*gMult);
      score+=Math.floor((50+combo*2)*gMult*(fever?2:1));
      combo++; tGood++;
      addFT(isGold?"\u2605GOOD":"GOOD",lx,HZY-35,"#7ec8ff",1);
      spawnP(lx,HZY,"#7ec8ff",6); sndGood();
    }
    if(combo>maxC) maxC=combo;
    if(!fever&&combo>=LP.feverTh){
      fever=true; feverTmr=0; feverFlash=1;
      showS(SERIFU.fever[Math.floor(Math.random()*SERIFU.fever.length)],2);
      sndFever(); shake=10;
    }
    if(combo>0&&combo%10===0){
      var ci=Math.floor(Math.random()*3);
      var pool=lv>=5?SERIFU.combo[ci].concat(SERIFU.high):SERIFU.combo[ci];
      showS(CN[ci]+"\uFF1A"+pool[sIdx%pool.length],2.2); sIdx++;
    }
    shake=Math.min(10,1+combo*0.12); borderGlow=Math.min(1,borderGlow+0.1); checkPh();
  }else{ spawnP(lx,HZY,"rgba(255,255,255,0.2)",2); }
}

function checkPh(){
  var np=0;
  for(var i=PH.length-1;i>=0;i--){if(yell>=PH[i].th){np=i;break;}}
  if(np>phase){
    phase=np; phCh=true; phTmr=2;
    showS(SERIFU.phase[phase],3); sndPhase(); shake=10;
    if(yell>=YM){state=ST.CLEAR; clrTmr=0; shake=0; sndClear();}
  }
}

function showS(t,d){sDisp={text:t,tmr:d,max:d};}
function addFT(t,x,y,c,s){ftxt.push({text:t,x:x,y:y,color:c,tmr:0.8,alpha:1,scale:s||1});}
function spawnP(x,y,c,n){
  for(var i=0;i<n;i++){
    var a=Math.random()*Math.PI*2, s=50+Math.random()*140;
    ptcl.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-50,color:c,
      life:0.5+Math.random()*0.4,ml:0.5+Math.random()*0.4,sz:1.5+Math.random()*3.5});
  }
}

function update(dt){
  bgScroll+=dt*15;
  if(state===ST.CLEAR){
    clrTmr+=dt;
    for(var pi=0;pi<ptcl.length;pi++){var p=ptcl[pi]; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=80*dt; p.life-=dt;}
    ptcl=ptcl.filter(function(p){return p.life>0;});
    if(clrTmr<4&&Math.random()<0.4){
      var cs=["#ffd700","#ff7eb3","#7ec8ff","#fff","#ffee00"];
      spawnP(Math.random()*VW,Math.random()*VH*0.4,cs[Math.floor(Math.random()*cs.length)],2);
    }
    return;
  }
  if(state!==ST.PLAY) return;
  tLeft-=dt;
  if(tLeft<=0){tLeft=0; if(yell<YM){state=ST.FAIL; shake=0;} return;}
  if(fever){feverTmr+=dt; feverFlash*=Math.max(0,1-dt*3);}
  var el=LP.dur-tLeft;
  var si=Math.max(LP.spM,LP.spB-el/LP.dur*0.12);
  spTmr-=dt;
  if(spTmr<=0){spawnN(); spTmr=si+(Math.random()-0.5)*0.1;}
  for(var ni=0;ni<notes.length;ni++){
    var n=notes[ni];
    if(!n.hit&&!n.miss){
      n.y+=n.spd*dt;
      if(Math.random()<0.3){
        var tc;
        if(n.type==="gold") tc="rgba(255,238,0,0.4)";
        else if(n.type==="danger") tc="rgba(255,50,50,0.3)";
        else tc=CC[n.lane];
        trails.push({x:laneX(n.lane)+(Math.random()-0.5)*6,y:n.y,life:0.3,ml:0.3,color:tc,sz:1+Math.random()*2});
      }
      if(n.y>HZY+LP.gR+25){
        if(n.type==="danger"){n.miss=true;}
        else{n.miss=true; combo=0; fever=false; tMiss++;
          addFT("MISS",laneX(n.lane),HZY-35,"#ff4444",1); sndMiss();}
      }
    }
  }
  notes=notes.filter(function(n){return !n.hit&&!(n.miss&&n.y>VH+50);});
  for(var ti=0;ti<trails.length;ti++){trails[ti].life-=dt; trails[ti].y+=10*dt;}
  trails=trails.filter(function(t){return t.life>0;});
  for(var pi2=0;pi2<ptcl.length;pi2++){var pp=ptcl[pi2]; pp.x+=pp.vx*dt; pp.y+=pp.vy*dt; pp.vy+=150*dt; pp.life-=dt;}
  ptcl=ptcl.filter(function(p){return p.life>0;});
  for(var fi=0;fi<ftxt.length;fi++){var ff=ftxt[fi]; ff.tmr-=dt; ff.y-=50*dt; ff.alpha=Math.max(0,ff.tmr/0.8);}
  ftxt=ftxt.filter(function(f){return f.tmr>0;});
  if(sDisp){sDisp.tmr-=dt; if(sDisp.tmr<=0) sDisp=null;}
  shake*=Math.max(0,1-dt*4.5); if(shake<0.2) shake=0;
  gThread=1+(yell/YM)*10;
  borderGlow*=Math.max(0,1-dt*1.5);
  if(phTmr>0){phTmr-=dt; if(phTmr<=0) phCh=false;}
}

function draw(){
  X.save(); X.scale(SC,SC);
  if(state===ST.PLAY&&shake>0) X.translate((Math.random()-0.5)*shake*2,(Math.random()-0.5)*shake*2);
  drawBG();
  if(state===ST.TITLE) drawTitle();
  else if(state===ST.PLAY) drawPlay();
  else if(state===ST.CLEAR) drawClear();
  else if(state===ST.FAIL) drawFail();
  if(state===ST.PLAY&&borderGlow>0.01){
    X.globalAlpha=borderGlow*0.4;
    X.strokeStyle=fever?"#ff4400":"#ffd700"; X.lineWidth=fever?6:4;
    X.strokeRect(2,2,VW-4,VH-4); X.globalAlpha=1;
  }
  X.restore();
}

function drawBG(){
  var yr=yell/YM;
  var g=X.createLinearGradient(0,0,0,VH);
  if(state===ST.TITLE){
    g.addColorStop(0,"#060620"); g.addColorStop(0.3,"#0c0c38");
    g.addColorStop(0.7,"#141450"); g.addColorStop(1,"#08081a");
  }else{
    var lt=Math.min(lv*1.5,25), ft=fever?20:0;
    g.addColorStop(0,"rgb("+Math.min(255,Math.floor(8+yr*35+lt+ft))+","+Math.min(255,Math.floor(8+yr*25))+","+Math.min(255,Math.floor(40-yr*15+lt*0.4))+")");
    g.addColorStop(0.5,"rgb("+Math.min(255,Math.floor(12+yr*45+ft))+","+Math.min(255,Math.floor(10+yr*35))+","+Math.min(255,Math.floor(50-yr*20))+")");
    g.addColorStop(1,"#08081a");
  }
  X.fillStyle=g; X.fillRect(0,0,VW,VH);
  drawStars(); drawMoon(yr);
  if(state===ST.PLAY||state===ST.CLEAR) drawThreads(yr);
  if(fever&&state===ST.PLAY) drawFeverBG();
}

var starData=null;
function drawStars(){
  if(!starData){starData=[];for(var i=0;i<60;i++) starData.push({x:Math.random()*VW,y:Math.random()*VH*0.6,s:Math.random()*2,tw:Math.random()*Math.PI*2,sp:0.5+Math.random()*1.5,layer:Math.random()});}
  var t=performance.now()/1000;
  for(var i=0;i<starData.length;i++){
    var s=starData[i], py=(s.y+bgScroll*s.sp)%(VH*0.6);
    X.fillStyle="rgba(255,255,255,"+(0.2+0.3*Math.sin(t*1.5+s.tw))+")";
    var sz=s.s*(s.layer>0.7?1.5:1);
    X.fillRect(s.x,py,sz,sz);
  }
}

function drawMoon(yr){
  var mx=VW*0.78,my=70,r=38+yr*12,a=0.25+yr*0.55;
  var h=X.createRadialGradient(mx,my,r*0.3,mx,my,r*4);
  h.addColorStop(0,"rgba(255,220,130,"+(a*0.3)+")"); h.addColorStop(0.4,"rgba(255,200,80,"+(a*0.08)+")"); h.addColorStop(1,"rgba(0,0,0,0)");
  X.fillStyle=h; X.beginPath(); X.arc(mx,my,r*4,0,Math.PI*2); X.fill();
  X.beginPath(); X.arc(mx,my,r,0,Math.PI*2);
  var mg=X.createRadialGradient(mx-r*0.3,my-r*0.3,0,mx,my,r);
  mg.addColorStop(0,"rgba(255,240,200,"+a+")"); mg.addColorStop(1,"rgba(230,190,100,"+(a*0.7)+")");
  X.fillStyle=mg; X.fill();
  X.globalAlpha=a*0.15; X.fillStyle="#c8a060";
  X.beginPath(); X.arc(mx+r*0.2,my-r*0.1,r*0.15,0,Math.PI*2); X.fill();
  X.beginPath(); X.arc(mx-r*0.3,my+r*0.25,r*0.1,0,Math.PI*2); X.fill();
  X.globalAlpha=1;
}

function drawThreads(yr){
  var t=performance.now()/1000, cnt=3+Math.floor(yr*6);
  for(var i=0;i<cnt;i++){
    var x=VW*0.15+VW*0.7*(i/Math.max(1,cnt-1));
    var a=0.03+yr*0.22, w=gThread*(0.4+0.6*Math.sin(t*2.5+i*1.1));
    X.save(); X.strokeStyle="rgba(255,215,100,"+a+")"; X.lineWidth=w;
    X.beginPath();
    for(var y=0;y<VH;y+=4){
      var wave=Math.sin(y*0.018+t*1.8+i*0.7)*(8+yr*18)+Math.sin(y*0.04+t*3)*(2+yr*5);
      if(y===0) X.moveTo(x+wave,y); else X.lineTo(x+wave,y);
    }
    X.stroke(); X.restore();
  }
}

function drawFeverBG(){
  var t=performance.now()/1000;
  X.globalAlpha=0.08+0.04*Math.sin(t*6);
  var fg=X.createLinearGradient(0,0,0,200);
  fg.addColorStop(0,"rgba(255,80,0,0.8)"); fg.addColorStop(0.5,"rgba(255,160,0,0.3)"); fg.addColorStop(1,"rgba(255,200,0,0)");
  X.fillStyle=fg; X.fillRect(0,0,VW,200); X.globalAlpha=1;
}

function drawTitle(){
  var t=performance.now()/1000;
  X.textAlign="center"; X.textBaseline="middle";
  var la=0.3+0.15*Math.sin(t*1.5);
  X.strokeStyle="rgba(200,168,78,"+la+")"; X.lineWidth=1;
  X.beginPath(); X.moveTo(60,195); X.lineTo(VW-60,195); X.stroke();
  X.beginPath(); X.moveTo(60,275); X.lineTo(VW-60,275); X.stroke();
  X.fillStyle="#f5d98a"; X.font="bold 30px serif";
  X.shadowColor="rgba(255,200,100,0.4)"; X.shadowBlur=20;
  X.fillText("\u5343\u5E74\u306E\u7D46",VW/2,225); X.shadowBlur=0;
  X.font="15px serif"; X.fillStyle="#c8a84e";
  X.fillText("\u2015\u6708\u306B\u8A93\u3063\u305F\u63A8\u3057\u306E\u5FC3\u2015",VW/2,258);
  X.fillStyle="rgba(180,180,220,"+(0.4+0.3*Math.sin(t*2))+")"; X.font="12px serif";
  X.fillText("\u6642\u7A7A\u3092\u8D85\u3048\u3066\u3001\u30A8\u30FC\u30EB\u3092\u9001\u308C",VW/2,310);
  if(bestLv>1){
    X.fillStyle="#ffd700"; X.font="bold 14px serif";
    X.fillText("\u6700\u9AD8\u5230\u9054 Lv"+bestLv+"\uFF1A"+lvName(bestLv),VW/2,350);
    X.fillStyle="rgba(180,180,220,0.5)"; X.font="12px serif";
    X.fillText("Lv"+lv+" \u304B\u3089\u958B\u59CB",VW/2,373);
  }
  drawTitleCharas(VW/2,440,t);
  X.fillStyle="rgba(180,180,220,0.35)"; X.font="11px serif";
  X.fillText("\u30BF\u30C3\u30D7\u3067\u5FDC\u63F4\u306E\u5149\u3092\u9001\u308D\u3046",VW/2,530);
  X.fillText("\u2605\u91D1\u30CE\u30FC\u30C8\uFF1D2\u500D  \u25CF\u8D64\u30CE\u30FC\u30C8\uFF1D\u56DE\u907F\uFF01",VW/2,550);
}

function drawTitleCharas(cx,cy,t){
  for(var i=0;i<3;i++){
    var x=cx+(i-1)*70, b=Math.sin(t*2+i*1.8)*4;
    X.globalAlpha=0.15+0.1*Math.sin(t*3+i);
    var gl=X.createRadialGradient(x,cy-5+b,0,x,cy-5+b,35);
    gl.addColorStop(0,CC[i]); gl.addColorStop(1,"rgba(0,0,0,0)");
    X.fillStyle=gl; X.fillRect(x-35,cy-40+b,70,70); X.globalAlpha=1;
    drawChara(x,cy+b,i,0.9);
    X.fillStyle=CC[i]; X.font="bold 11px serif"; X.textAlign="center";
    X.fillText(CN[i],x,cy+35+b);
  }
}

function drawChara(x,y,idx,s){
  X.save(); X.translate(x,y); X.scale(s,s);
  var c=CC[idx], c2=CC2[idx];
  X.fillStyle=c; X.beginPath(); X.arc(0,-20,10,0,Math.PI*2); X.fill();
  X.strokeStyle=c2; X.lineWidth=1; X.stroke();
  X.fillStyle="#1a1a2e"; X.fillRect(-4,-22,3,3); X.fillRect(2,-22,3,3);
  X.fillStyle=c; X.globalAlpha=0.9;
  X.beginPath(); X.moveTo(-8,-10); X.lineTo(8,-10); X.lineTo(10,12); X.lineTo(-10,12); X.closePath(); X.fill();
  X.globalAlpha=1; X.fillStyle=c2; X.fillRect(-8,2,16,4);
  X.strokeStyle=c; X.lineWidth=3; X.lineCap="round";
  X.beginPath(); X.moveTo(-8,-5); X.lineTo(-14,5); X.stroke();
  X.beginPath(); X.moveTo(8,-5); X.lineTo(14,5); X.stroke();
  X.restore();
}

function drawPlay(){
  drawLanes(); drawTrails(); drawNotes(); drawHitZone();
  drawPtcl(); drawFTxt(); drawUI(); drawKintaro(); drawSerifu();
  if(phCh&&phTmr>0){X.globalAlpha=Math.min(1,phTmr)*0.25; X.fillStyle="#ffd700"; X.fillRect(0,0,VW,VH); X.globalAlpha=1;}
}

function drawLanes(){
  for(var i=0;i<LC;i++){
    var x=laneX(i);
    var lg=X.createLinearGradient(0,130,0,HZY+50);
    lg.addColorStop(0,"rgba(0,0,0,0)");
    var rgb=i===0?"200,180,100":i===1?"100,160,220":"200,100,150";
    lg.addColorStop(0.5,"rgba("+rgb+","+(fever?0.08:0.04)+")"); lg.addColorStop(1,"rgba("+rgb+",0.02)");
    X.fillStyle=lg; X.fillRect(x-LW/2,130,LW,HZY-80);
    X.strokeStyle="rgba(255,255,255,"+(fever?0.08:0.04)+")"; X.lineWidth=1;
    X.beginPath(); X.moveTo(x-LW/2,130); X.lineTo(x-LW/2,HZY+30); X.stroke();
    X.beginPath(); X.moveTo(x+LW/2,130); X.lineTo(x+LW/2,HZY+30); X.stroke();
  }
}

function drawTrails(){
  for(var i=0;i<trails.length;i++){
    var tr=trails[i], a=tr.life/tr.ml;
    X.globalAlpha=a*0.5; X.fillStyle=tr.color;
    X.beginPath(); X.arc(tr.x,tr.y,tr.sz*a,0,Math.PI*2); X.fill();
  }
  X.globalAlpha=1;
}

function drawNotes(){
  var t=performance.now()/1000;
  for(var ni=0;ni<notes.length;ni++){
    var n=notes[ni]; if(n.hit) continue;
    var x=laneX(n.lane), pulse=0.85+0.15*Math.sin(t*8+n.pulse), r=NR*pulse;
    var col,col2,glowCol;
    if(n.type==="gold"){col="#ffee00";col2="#ffaa00";glowCol="rgba(255,238,0,0.35)";}
    else if(n.type==="danger"){col="#ff3333";col2="#aa0000";glowCol="rgba(255,50,50,0.3)";}
    else{col=CC[n.lane];col2=CC2[n.lane];glowCol="rgba(200,200,200,0.2)";}
    var gr=r*2.5, glow=X.createRadialGradient(x,n.y,0,x,n.y,gr);
    glow.addColorStop(0,glowCol); glow.addColorStop(1,"rgba(0,0,0,0)");
    X.fillStyle=glow; X.beginPath(); X.arc(x,n.y,gr,0,Math.PI*2); X.fill();
    X.beginPath(); X.arc(x,n.y,r,0,Math.PI*2);
    var ng=X.createRadialGradient(x-r*0.2,n.y-r*0.2,0,x,n.y,r);
    ng.addColorStop(0,"#fff"); ng.addColorStop(0.35,col); ng.addColorStop(1,col2);
    X.fillStyle=ng; X.fill();
    if(n.type==="gold"){
      X.save(); X.translate(x,n.y); X.rotate(t*3);
      X.strokeStyle="rgba(255,255,200,0.6)"; X.lineWidth=1.5;
      for(var si=0;si<4;si++){X.rotate(Math.PI/4); X.beginPath(); X.moveTo(0,-r-3); X.lineTo(0,-r-8); X.stroke();}
      X.restore();
    }
    if(n.type==="danger"){
      X.strokeStyle="#fff"; X.lineWidth=2.5; X.lineCap="round";
      X.beginPath(); X.moveTo(x-6,n.y-6); X.lineTo(x+6,n.y+6); X.stroke();
      X.beginPath(); X.moveTo(x+6,n.y-6); X.lineTo(x-6,n.y+6); X.stroke();
    }
    if(n.type==="normal"){
      X.fillStyle="#fff"; X.font="bold 11px serif"; X.textAlign="center"; X.textBaseline="middle";
      X.fillText(["\u7687","\uFF11","\uFF12"][n.lane],x,n.y);
    }
    if(n.miss&&n.type!=="danger"){
      X.globalAlpha=0.4; X.fillStyle="#ff0000"; X.beginPath(); X.arc(x,n.y,r,0,Math.PI*2); X.fill(); X.globalAlpha=1;
    }
  }
}

function drawHitZone(){
  var t=performance.now()/1000;
  for(var i=0;i<LC;i++){
    var x=laneX(i), p=0.25+0.2*Math.sin(t*4+i);
    X.strokeStyle=fever?"rgba(255,150,50,"+(p+0.2)+")":"rgba(255,255,255,"+p+")";
    X.lineWidth=fever?3:2;
    X.strokeRect(x-LW/2+4,HZY-HZH/2,LW-8,HZH);
    X.fillStyle=fever?"rgba(255,100,0,"+(p*0.15)+")":"rgba(255,255,255,"+(p*0.08)+")";
    X.fillRect(x-LW/2+4,HZY-HZH/2,LW-8,HZH);
    X.fillStyle=CC[i]; X.font="10px serif"; X.textAlign="center"; X.textBaseline="top";
    X.fillText(CN[i],x,HZY+HZH/2+6);
  }
}

function drawPtcl(){
  for(var i=0;i<ptcl.length;i++){var p=ptcl[i]; X.globalAlpha=p.life/p.ml; X.fillStyle=p.color;
    X.beginPath(); X.arc(p.x,p.y,p.sz*(p.life/p.ml),0,Math.PI*2); X.fill();}
  X.globalAlpha=1;
}

function drawFTxt(){
  for(var i=0;i<ftxt.length;i++){var f=ftxt[i];
    X.globalAlpha=f.alpha;
    var sz=Math.min(18,14*f.scale+2*(1-f.alpha));
    X.fillStyle=f.color; X.font="bold "+sz+"px serif";
    X.textAlign="center"; X.textBaseline="middle";
    X.shadowColor="rgba(0,0,0,0.5)"; X.shadowBlur=4;
    X.fillText(f.text,f.x,f.y); X.shadowBlur=0;}
  X.globalAlpha=1;
}

function drawUI(){
  var pg=X.createLinearGradient(0,0,0,125);
  pg.addColorStop(0,"rgba(0,0,0,0.65)"); pg.addColorStop(1,"rgba(0,0,0,0)");
  X.fillStyle=pg; X.fillRect(0,0,VW,125);
  var lc2=lv>=10?"#ff4444":lv>=5?"#ff8844":"#c8a84e";
  X.fillStyle=lc2; X.font="bold 12px serif"; X.textAlign="left"; X.textBaseline="top";
  X.fillText("Lv"+lv+" "+lvName(lv),10,5);
  X.fillStyle="rgba(255,255,255,0.5)"; X.font="11px serif"; X.textAlign="right";
  X.fillText("SCORE "+score.toLocaleString(),VW-10,5);
  var gx=15,gy=24,gw=VW-30,gh=22;
  X.fillStyle="rgba(0,0,0,0.4)"; X.fillRect(gx-1,gy-1,gw+2,gh+2);
  X.strokeStyle=fever?"#ff6600":"#c8a84e"; X.lineWidth=1.5; X.strokeRect(gx,gy,gw,gh);
  var fw=(yell/YM)*gw, gg=X.createLinearGradient(gx,0,gx+gw,0);
  if(fever){gg.addColorStop(0,"#ff4400");gg.addColorStop(0.5,"#ff8800");gg.addColorStop(1,"#ffcc00");}
  else{gg.addColorStop(0,"#3366cc");gg.addColorStop(0.5,"#c8a84e");gg.addColorStop(1,"#ffd700");}
  X.fillStyle=gg; X.fillRect(gx,gy,fw,gh);
  X.globalAlpha=0.15; X.fillStyle="#fff"; X.fillRect(gx,gy,fw,gh/2); X.globalAlpha=1;
  for(var i=1;i<PH.length;i++){
    var mx=gx+(PH[i].th/YM)*gw;
    X.strokeStyle="rgba(255,255,255,0.3)"; X.lineWidth=1;
    X.beginPath(); X.moveTo(mx,gy); X.lineTo(mx,gy+gh); X.stroke();
  }
  X.fillStyle="#fff"; X.font="bold 11px serif"; X.textAlign="center"; X.textBaseline="middle";
  X.shadowColor="rgba(0,0,0,0.5)"; X.shadowBlur=3;
  X.fillText("\u30A8\u30FC\u30EB "+Math.floor(yell)+"%",VW/2,gy+gh/2); X.shadowBlur=0;
  X.fillStyle=tLeft<=10?"#ff5555":"#ddd"; X.font="bold 14px serif"; X.textAlign="left";
  X.fillText(Math.ceil(tLeft).toString(),15,58);
  X.fillStyle="rgba(255,255,255,0.4)"; X.font="10px serif"; X.fillText("\u79D2",33,60);
  if(fever){
    var fa=0.7+0.3*Math.sin(performance.now()/1000*6);
    X.fillStyle="rgba(255,100,0,"+fa+")"; X.font="bold 14px serif"; X.textAlign="center";
    X.fillText("FEVER",VW/2,58);
  }
  if(combo>0){
    var cs2=Math.min(26,14+combo*0.25);
    X.fillStyle=combo>=20?"#ffee00":combo>=10?"#ffd700":"#fff";
    X.font="bold "+cs2+"px serif"; X.textAlign="right";
    X.shadowColor="rgba(0,0,0,0.6)"; X.shadowBlur=4;
    X.fillText(combo.toString(),VW-45,60); X.shadowBlur=0;
    X.fillStyle="rgba(255,255,255,0.5)"; X.font="10px serif";
    X.fillText("COMBO",VW-12,60);
  }
  X.fillStyle="#c8a84e"; X.font="12px serif"; X.textAlign="center";
  X.fillText(PH[phase].lb,VW/2,82);
  if(!fever&&combo>0){
    var fp=Math.min(1,combo/LP.feverTh);
    var fbx=VW/2-40,fby=94,fbw=80,fbh=6;
    X.fillStyle="rgba(0,0,0,0.3)"; X.fillRect(fbx,fby,fbw,fbh);
    var ffg=X.createLinearGradient(fbx,0,fbx+fbw,0);
    ffg.addColorStop(0,"#ff6600"); ffg.addColorStop(1,"#ffaa00");
    X.fillStyle=ffg; X.fillRect(fbx,fby,fbw*fp,fbh);
    X.fillStyle="rgba(255,255,255,0.3)"; X.font="8px serif";
    X.fillText("FEVER",VW/2,fby+fbh+8);
  }
  if(tLeft>LP.dur-3.5){
    X.globalAlpha=Math.max(0,1-(LP.dur-tLeft)/3.5);
    X.fillStyle="rgba(255,255,255,0.6)"; X.font="12px serif"; X.textAlign="center";
    X.fillText("\u25BC \u5149\u304C\u6765\u305F\u3089\u30BF\u30C3\u30D7\uFF01 \u25BC",VW/2,115);
    X.globalAlpha=1;
  }
}

function drawKintaro(){
  var kx=VW-52, ky=175, st=PH[phase].st;
  X.save(); X.translate(kx,ky);
  X.fillStyle="rgba(255,220,130,0.6)"; X.font="9px serif"; X.textAlign="center";
  X.fillText("\u91D1\u592A\u90CE",0,-45);
  var yr=yell/YM;
  X.globalAlpha=yr*0.2;
  var kg=X.createRadialGradient(0,-5,0,0,-5,40);
  kg.addColorStop(0,"rgba(255,200,100,0.5)"); kg.addColorStop(1,"rgba(0,0,0,0)");
  X.fillStyle=kg; X.beginPath(); X.arc(0,-5,40,0,Math.PI*2); X.fill(); X.globalAlpha=1;
  switch(st){
    case "fallen":
      X.save(); X.rotate(Math.PI*0.45); drawKF(0,0,0.8); X.restore();
      X.fillStyle="#ff6666"; X.font="10px serif"; X.fillText("\u00D7_\u00D7",18,5); break;
    case "kneel":
      X.save(); X.rotate(Math.PI/7); drawKF(0,0,0.85); X.restore();
      X.fillStyle="#ffaa44"; X.font="9px serif"; X.fillText("\u3046\u2026",18,-8); break;
    case "rise":
      X.save(); X.rotate(Math.PI/14); drawKF(0,0,0.92); X.restore();
      X.fillStyle="#ffc844"; X.font="9px serif"; X.fillText("\u2026\uFF01",18,-12); break;
    case "grip":
      drawKF(0,0,1);
      X.strokeStyle="#b0b0c0"; X.lineWidth=2.5; X.lineCap="round";
      X.beginPath(); X.moveTo(12,-5); X.lineTo(28,-22); X.stroke();
      X.fillStyle="#e0e0e0"; X.beginPath(); X.arc(28,-22,2.5,0,Math.PI*2); X.fill(); break;
    case "stand":
      drawKF(0,0,1);
      X.strokeStyle="#ffd700"; X.lineWidth=3; X.lineCap="round";
      X.beginPath(); X.moveTo(10,-12); X.lineTo(22,-35); X.stroke();
      X.fillStyle="#ffd700"; X.beginPath(); X.arc(22,-35,3,0,Math.PI*2); X.fill();
      X.globalAlpha=0.3+0.2*Math.sin(performance.now()/1000*4);
      var sg=X.createRadialGradient(22,-35,0,22,-35,15);
      sg.addColorStop(0,"rgba(255,215,0,0.5)"); sg.addColorStop(1,"rgba(0,0,0,0)");
      X.fillStyle=sg; X.beginPath(); X.arc(22,-35,15,0,Math.PI*2); X.fill(); X.globalAlpha=1; break;
    case "run": drawKF(0,0,1); break;
  }
  X.restore();
}

function drawKF(x,y,s){
  X.save(); X.translate(x,y); X.scale(s,s);
  X.fillStyle="#e8c56d"; X.beginPath(); X.arc(0,-22,9,0,Math.PI*2); X.fill();
  X.strokeStyle="#b8952d"; X.lineWidth=1; X.stroke();
  X.strokeStyle="#cc3333"; X.lineWidth=2; X.beginPath(); X.arc(0,-22,9,-0.3,Math.PI+0.3); X.stroke();
  X.fillStyle="#222"; X.fillRect(-4,-24,2.5,2.5); X.fillRect(2,-24,2.5,2.5);
  X.fillStyle="#e8c56d";
  X.beginPath(); X.moveTo(-9,-13); X.lineTo(9,-13); X.lineTo(10,8); X.lineTo(-10,8); X.closePath(); X.fill();
  X.fillStyle="#cc3333"; X.fillRect(-7,-2,14,10);
  X.fillStyle="#aa2222"; X.font="bold 6px serif"; X.textAlign="center"; X.textBaseline="middle";
  X.fillText("\u91D1",0,4);
  X.strokeStyle="#e8c56d"; X.lineWidth=3.5; X.lineCap="round";
  X.beginPath(); X.moveTo(-9,-8); X.lineTo(-15,4); X.stroke();
  X.beginPath(); X.moveTo(9,-8); X.lineTo(15,4); X.stroke();
  X.lineWidth=3;
  X.beginPath(); X.moveTo(-6,8); X.lineTo(-8,22); X.stroke();
  X.beginPath(); X.moveTo(6,8); X.lineTo(8,22); X.stroke();
  X.restore();
}

function drawSerifu(){
  if(!sDisp) return;
  var fi=Math.min(1,(sDisp.max-sDisp.tmr)/0.25), fo=Math.min(1,sDisp.tmr/0.4);
  X.globalAlpha=fi*fo;
  X.font="bold 13px serif";
  var tw=X.measureText(sDisp.text).width;
  var bx=VW/2-tw/2-18, by=648, bw=tw+36, bh=34;
  X.fillStyle="rgba(0,0,0,0.7)"; X.fillRect(bx,by,bw,bh);
  X.strokeStyle="rgba(200,168,78,0.4)"; X.lineWidth=1; X.strokeRect(bx,by,bw,bh);
  X.fillStyle="#ffd700"; X.textAlign="center"; X.textBaseline="middle";
  X.fillText(sDisp.text,VW/2,by+bh/2); X.globalAlpha=1;
}

function calcRank(){
  var total=tPerf+tGood+tMiss;
  if(total===0) return {rank:"C",color:"#888"};
  var pr=tPerf/total, mr=tMiss/total;
  if(pr>=0.9&&mr<=0.02) return {rank:"S",color:"#ffee00"};
  if(pr>=0.75&&mr<=0.08) return {rank:"A",color:"#ffd700"};
  if(pr>=0.5&&mr<=0.2) return {rank:"B",color:"#7ec8ff"};
  return {rank:"C",color:"#aaa"};
}

function drawClear(){
  drawPtcl(); var t=clrTmr;
  if(t<1.2){X.globalAlpha=Math.max(0,1-t/1.2)*0.5; X.fillStyle="#ffd700"; X.fillRect(0,0,VW,VH); X.globalAlpha=1;}
  X.save();
  var rx=VW*0.3+Math.min(VW*0.4,t*50), rb=Math.sin(t*14)*3;
  X.translate(rx,310+rb); drawKF(0,0,1.6);
  X.strokeStyle="#ffd700"; X.lineWidth=3.5; X.lineCap="round";
  X.beginPath(); X.moveTo(18,-18); X.lineTo(40,-45); X.stroke();
  X.fillStyle="#ffd700"; X.beginPath(); X.arc(40,-45,4,0,Math.PI*2); X.fill();
  X.strokeStyle="rgba(255,215,0,0.3)"; X.lineWidth=2;
  for(var i=0;i<3;i++){X.beginPath(); X.moveTo(-20-i*12,-5+i*6); X.lineTo(-40-i*15,-5+i*6); X.stroke();}
  X.restore();
  X.textAlign="center"; X.textBaseline="middle";
  if(t>0.6){
    var a=Math.min(1,(t-0.6)/0.5); X.globalAlpha=a;
    X.fillStyle="#ffd700"; X.font="bold 22px serif";
    X.shadowColor="rgba(255,200,0,0.4)"; X.shadowBlur=15;
    X.fillText("\u2500\u2500 \u91D1\u592A\u90CE\u306F\u8D70\u308A\u51FA\u3057\u305F \u2500\u2500",VW/2,410); X.shadowBlur=0;
    X.fillStyle="#fff"; X.font="bold 16px serif";
    X.fillText("Lv"+lv+" CLEAR!",VW/2,448);
    var rk=calcRank();
    X.fillStyle=rk.color; X.font="bold 36px serif";
    X.shadowColor=rk.color; X.shadowBlur=20;
    X.fillText(rk.rank,VW/2,490); X.shadowBlur=0;
    X.fillStyle="#ddd"; X.font="12px serif";
    X.fillText("SCORE "+score.toLocaleString()+"  \u6700\u5927\u30B3\u30F3\u30DC "+maxC,VW/2,525);
    X.fillText("Perfect:"+tPerf+"  Good:"+tGood+"  Miss:"+tMiss,VW/2,545);
    var nl=Math.min(MAX_LV,lv+1);
    X.fillStyle="#ff8844"; X.font="bold 13px serif";
    X.fillText("\u2192 Lv"+nl+"\uFF1A"+lvName(nl),VW/2,575);
  }
  if(t>2){
    X.globalAlpha=Math.min(1,(t-2)/1);
    X.fillStyle="#f5d98a"; X.font="bold 26px serif";
    X.shadowColor="rgba(255,200,100,0.3)"; X.shadowBlur=15;
    X.fillText("\u5343\u5E74\u306E\u7D46",VW/2,175); X.shadowBlur=0;
    X.font="14px serif"; X.fillStyle="#c8a84e";
    X.fillText("\u2015\u6708\u306B\u8A93\u3063\u305F\u63A8\u3057\u306E\u5FC3\u2015",VW/2,208);
  }
  X.globalAlpha=1;
  if(t>2.3){bN.style.display="inline-block"; bR.style.display="inline-block"; bT.style.display="inline-block";}
}

function drawFail(){
  X.fillStyle="rgba(0,0,0,0.65)"; X.fillRect(0,0,VW,VH);
  X.textAlign="center"; X.textBaseline="middle";
  X.save(); X.translate(VW/2,280); X.rotate(Math.PI*0.4); drawKF(0,0,1.2); X.restore();
  X.fillStyle="#6666aa"; X.font="bold 22px serif";
  X.fillText("\u2026\u58F0\u306F\u3001\u5C4A\u304B\u306A\u304B\u3063\u305F",VW/2,370);
  X.fillStyle="#8888bb"; X.font="14px serif";
  X.fillText("Lv"+lv+"  \u30A8\u30FC\u30EB: "+Math.floor(yell)+"%",VW/2,415);
  X.fillText("SCORE "+score.toLocaleString()+"  \u6700\u5927\u30B3\u30F3\u30DC "+maxC,VW/2,440);
  X.fillStyle="rgba(180,180,220,0.5)"; X.font="13px serif";
  X.fillText("\u3060\u304C\u3001\u5343\u5E74\u306E\u7D46\u306F\u6D88\u3048\u306A\u3044\u2500\u2500",VW/2,490);
  X.fillText("\u4F55\u5EA6\u3067\u3082\u3001\u58F0\u3092\u5C4A\u3051\u3088\u3046",VW/2,515);
  bR.style.display="inline-block"; bT.style.display="inline-block";
}

function loop(ts){
  var dt=Math.min(0.05,(ts-lastT)/1000); lastT=ts;
  update(dt); draw(); requestAnimationFrame(loop);
}

C.addEventListener("touchstart",function(e){
  e.preventDefault();
  for(var i=0;i<e.changedTouches.length;i++) tap(e.changedTouches[i].clientX,e.changedTouches[i].clientY);
},{passive:false});
C.addEventListener("mousedown",function(e){tap(e.clientX,e.clientY);});

bS.addEventListener("click",startGame);
bS.addEventListener("touchend",function(e){e.preventDefault();startGame();});
bN.addEventListener("click",nextLv);
bN.addEventListener("touchend",function(e){e.preventDefault();nextLv();});
bR.addEventListener("click",startGame);
bR.addEventListener("touchend",function(e){e.preventDefault();startGame();});
function goTitle(){state=ST.TITLE; lv=bestLv; reset(); hideB(); bS.style.display="inline-block";}
bT.addEventListener("click",goTitle);
bT.addEventListener("touchend",function(e){e.preventDefault();goTitle();});

lastT=performance.now(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>
